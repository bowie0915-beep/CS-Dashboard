import React, { useState, useMemo, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, BarChart, Bar } from 'recharts';
import { Upload, Users, TrendingUp, Activity, FileText, PlusCircle, Download, Trash2, Search, Calendar, CheckCircle, AlertCircle, X, Info, RotateCcw, Database, Trophy, AlertTriangle, Target, Save, MessageSquare, Star, RefreshCw, Layout, Clipboard, FileSpreadsheet, Link, Globe } from 'lucide-react';

const CATEGORIES = [
  { key: 'etiquette', label: '電話禮儀' },
  { key: 'voice', label: '聲音表情' },
  { key: 'knowledge', label: '專業知識' },
  { key: 'solution', label: '問題解決' },
  { key: 'handling', label: '應對技巧' },
];

// 3. 欄位對齊設定 (保留彈性異動)
// 定義 Google Sheet / CSV 的欄位索引順序
const SHEET_COLUMN_MAP = {
  date: 0,      // 日期
  name: 1,      // 姓名
  etiquette: 2, // 電話禮儀
  voice: 3,     // 聲音表情
  knowledge: 4, // 專業知識
  solution: 5,  // 問題解決
  handling: 6   // 應對技巧
};

// 定義線條顏色
const COLORS = {
  etiquette: '#10B981', // 綠色
  voice: '#8B5CF6',     // 紫色
  knowledge: '#3B82F6', // 藍色
  solution: '#EC4899',  // 粉紅
  handling: '#F59E0B'   // 橘黃
};

const App = () => {
  // 1. State 初始化
  const [data, setData] = useState(() => {
    try {
      const savedData = localStorage.getItem('qa_dashboard_data');
      return savedData ? JSON.parse(savedData) : [];
    } catch (e) {
      console.error("讀取儲存資料失敗", e);
      return [];
    }
  });

  const [selectedAgent, setSelectedAgent] = useState('All');
  const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
  const [pasteContent, setPasteContent] = useState(''); // 用於 Excel/Google Sheet 貼上
  
  // 2. 連結請預設為指定網址
  const [googleSheetUrl, setGoogleSheetUrl] = useState('https://docs.google.com/spreadsheets/d/1tBypNYzm9fk0Sy4d2tginwkDNEh7Pu80XUXmw1YEqQE/edit?gid=2072128312#gid=2072128312'); 

  // 系統目前月份
  const currentSystemMonth = useMemo(() => {
    return new Date().toISOString().slice(0, 7); 
  }, []);

  const [dateRange, setDateRange] = useState({
    start: currentSystemMonth,
    end: currentSystemMonth
  });

  const [view, setView] = useState('dashboard'); 
  
  const [newEntry, setNewEntry] = useState({
    date: new Date().toISOString().split('T')[0],
    name: '',
    etiquette: 80,
    voice: 80,
    knowledge: 80,
    solution: 80,
    handling: 80
  });

  // Effect
  useEffect(() => {
    try {
      localStorage.setItem('qa_dashboard_data', JSON.stringify(data));
    } catch (e) {
      console.error("儲存資料失敗", e);
    }
  }, [data]);

  const showToast = (message, type = 'success') => {
    setToast({ show: true, message, type });
  };

  useEffect(() => {
    if (toast.show) {
      const timer = setTimeout(() => {
        setToast(prev => ({ ...prev, show: false }));
      }, 3000);
      return () => clearTimeout(timer);
    }
  }, [toast.show]);

  const agents = useMemo(() => {
    const names = new Set(data.map(d => d.name));
    return ['All', ...Array.from(names)];
  }, [data]);

  // A. 先篩選出符合「日期區間」的所有資料 (Team Base)
  const dateFilteredData = useMemo(() => {
    if (!dateRange.start || !dateRange.end) return data;
    return data.filter(d => {
      const itemMonth = d.date.slice(0, 7);
      return itemMonth >= dateRange.start && itemMonth <= dateRange.end;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));
  }, [data, dateRange]);

  // B. 再根據「選擇的人員」篩選出顯示資料 (Display Base)
  const displayData = useMemo(() => {
    if (selectedAgent === 'All') return dateFilteredData;
    return dateFilteredData.filter(d => d.name === selectedAgent);
  }, [dateFilteredData, selectedAgent]);

  // 雷達圖數據
  const radarData = useMemo(() => {
    if (displayData.length === 0 && dateFilteredData.length === 0) return [];
    
    return CATEGORIES.map(cat => {
      const currentTotal = displayData.reduce((sum, item) => sum + Number(item[cat.key]), 0);
      const currentAvg = displayData.length ? Math.round(currentTotal / displayData.length) : 0;

      const teamTotal = dateFilteredData.reduce((sum, item) => sum + Number(item[cat.key]), 0);
      const teamAvg = dateFilteredData.length ? Math.round(teamTotal / dateFilteredData.length) : 0;

      return {
        subject: cat.label,
        current: currentAvg,
        team: teamAvg,
        fullMark: 100,
      };
    });
  }, [displayData, dateFilteredData]);

  // 診斷數據
  const insights = useMemo(() => {
    if (displayData.length === 0) return null;

    const averages = CATEGORIES.map(cat => {
      const total = displayData.reduce((sum, item) => sum + Number(item[cat.key]), 0);
      return {
        label: cat.label,
        score: Math.round(total / displayData.length)
      };
    });

    averages.sort((a, b) => b.score - a.score);
    
    return {
      best: averages[0],
      worst: averages[averages.length - 1],
      totalAvg: Math.round(averages.reduce((sum, i) => sum + i.score, 0) / 5)
    };
  }, [displayData]);

  // 生成智能評語
  const summaryText = useMemo(() => {
    if (!insights) return null;
    const { best, worst, totalAvg } = insights;
    
    let comment = '';

    if (totalAvg >= 90) {
      comment = '整體表現非常出色，各項指標皆維持高水準，建議可作為內部培訓講師或標竿範例。';
    } else if (totalAvg >= 80) {
      comment = '表現穩定且良好，大部分指標皆在標準之上，請繼續保持目前的服務品質。';
    } else if (totalAvg >= 70) {
      comment = '整體表現及格但仍有進步空間，建議針對弱項進行微調，以提升客戶滿意度。';
    } else {
      comment = '整體表現低於預期，建議主管介入輔導，並安排個別面談了解執行困難點。';
    }

    const advice = `建議優先針對「${worst.label} (${worst.score}分)」進行加強，可透過模擬演練或聽取優秀錄音來改善。同時請繼續保持「${best.label} (${best.score}分)」的優勢項目。`;

    return { comment, advice };
  }, [insights]);

  const trendData = useMemo(() => {
    return displayData.map(item => ({
      ...item,
      etiquette: Number(item.etiquette),
      voice: Number(item.voice),
      knowledge: Number(item.knowledge),
      solution: Number(item.solution),
      handling: Number(item.handling),
    }));
  }, [displayData]);

  const normalizeDate = (dateStr) => {
    if (!dateStr) return '';
    const match = dateStr.trim().match(/^(\d{4})[-/.](\d{1,2})[-/.](\d{1,2})/);
    if (match) {
      const year = match[1];
      const month = match[2].padStart(2, '0');
      const day = match[3].padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    try {
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    } catch (e) {
      return dateStr;
    }
  };

  const processImportData = (newData) => {
      if (newData.length > 0) {
        setData(prev => {
          // 合併資料時，這裡採用簡單的附加方式。若需要去重，可根據 ID 或日期+姓名判斷。
          // 這裡為了讓「同步」有感，我們示範 "更新式" 的匯入 (這裡簡單做：保留舊的，加入新的)
          // 實務上可能需要清空舊資料或比對 ID
          
          // 簡單邏輯：先保留既有，加入新的
          const updatedData = [...prev, ...newData];
          
          if (updatedData.length > 0) {
            const dates = updatedData.map(d => d.date).sort();
            const minMonth = dates[0].slice(0, 7);
            const maxMonth = dates[dates.length - 1].slice(0, 7);
            setTimeout(() => {
               setDateRange({ start: minMonth, end: maxMonth });
            }, 100);
          }
          return updatedData;
        });
        showToast(`同步成功！已讀取 ${newData.length} 筆資料`, 'success');
      } else {
        showToast('同步完成，但未發現新資料', 'warning');
      }
  };

  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const text = e.target.result;
        const lines = text.split('\n');
        const newData = [];
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line) {
            const cols = line.split(',');
            // 使用 SHEET_COLUMN_MAP 的最大索引來檢查
            const maxIndex = Math.max(...Object.values(SHEET_COLUMN_MAP));
            if (cols.length > maxIndex) {
              newData.push({
                id: Date.now() + i + Math.random(),
                date: normalizeDate(cols[SHEET_COLUMN_MAP.date].trim()),
                name: cols[SHEET_COLUMN_MAP.name].trim(),
                etiquette: Number(cols[SHEET_COLUMN_MAP.etiquette]),
                voice: Number(cols[SHEET_COLUMN_MAP.voice]),
                knowledge: Number(cols[SHEET_COLUMN_MAP.knowledge]),
                solution: Number(cols[SHEET_COLUMN_MAP.solution]),
                handling: Number(cols[SHEET_COLUMN_MAP.handling]),
              });
            }
          }
        }
        processImportData(newData);
      } catch (err) {
        showToast('檔案讀取發生錯誤', 'error');
      }
    };
    reader.readAsText(file);
    event.target.value = ''; 
  };

  // 1. & 4. 處理 Google Sheet URL 匯入 (動態讀取 + 同步)
  const handleGoogleSheetImport = async () => {
    if (!googleSheetUrl) return showToast('請輸入 Google Sheet 網址', 'error');
    
    let fetchUrl = googleSheetUrl;

    // 1. 自動轉換標準 Google Sheet 網址為 CSV 匯出網址
    // 範例: https://docs.google.com/spreadsheets/d/{ID}/edit?gid={GID} -> https://docs.google.com/spreadsheets/d/{ID}/export?format=csv&gid={GID}
    const idMatch = googleSheetUrl.match(/\/d\/([a-zA-Z0-9-_]+)/);
    const gidMatch = googleSheetUrl.match(/[?&#]gid=(\d+)/);

    if (idMatch) {
        const sheetId = idMatch[1];
        const gid = gidMatch ? gidMatch[1] : '0'; // 預設第一張表
        fetchUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
    } else if (!googleSheetUrl.includes('output=csv') && !googleSheetUrl.includes('export?format=csv')) {
         // 如果既不是標準網址，也不是 CSV 連結，跳出警告
         if (!window.confirm('這看起來不像標準的 Google Sheet 連結，系統嘗試讀取可能失敗。\n確定要繼續嗎？')) {
            return;
         }
    }

    try {
        const response = await fetch(fetchUrl);
        if (!response.ok) throw new Error('無法讀取資料，請確認連結權限是否為「公開/知道連結者皆可檢視」');
        const text = await response.text();
        
        const lines = text.split(/\r?\n/);
        const newData = [];
        
        // 3. 欄位對齊與彈性讀取
        lines.forEach((line, index) => {
            if (!line.trim()) return;
            const cols = line.split(','); // 簡單 CSV 處理
            
            // 判斷是否為標題列 (檢查第一欄是否為日期格式)
            const isHeader = isNaN(new Date(cols[SHEET_COLUMN_MAP.date]).getTime()) && index === 0;

            const maxIndex = Math.max(...Object.values(SHEET_COLUMN_MAP));

            if (cols.length > maxIndex && !isHeader) {
                newData.push({
                    id: Date.now() + index + Math.random(),
                    date: normalizeDate(cols[SHEET_COLUMN_MAP.date].trim()),
                    name: cols[SHEET_COLUMN_MAP.name].trim(),
                    etiquette: Number(cols[SHEET_COLUMN_MAP.etiquette]),
                    voice: Number(cols[SHEET_COLUMN_MAP.voice]),
                    knowledge: Number(cols[SHEET_COLUMN_MAP.knowledge]),
                    solution: Number(cols[SHEET_COLUMN_MAP.solution]),
                    handling: Number(cols[SHEET_COLUMN_MAP.handling]),
                });
            }
        });

        if (newData.length === 0) {
             showToast('讀取成功但無有效資料 (可能格式不符或標題列誤判)', 'warning');
        } else {
             processImportData(newData);
             // 不清空 URL，方便使用者再次點擊同步
        }
    } catch (e) {
        console.error(e);
        showToast('同步失敗：' + e.message, 'error');
    }
  };

  // 處理貼上事件
  const handleSmartPaste = () => {
    if (!pasteContent.trim()) return showToast('請先貼上資料', 'error');

    try {
        const rows = pasteContent.trim().split(/\r?\n/);
        const newData = [];

        rows.forEach((row, index) => {
            // Excel/Google Sheet 複製通常是 Tab 分隔
            const cols = row.split('\t');
            // 備用：逗號分隔
            const colsCsv = row.split(',');
            const finalCols = cols.length >= 7 ? cols : (colsCsv.length >= 7 ? colsCsv : null);
            
            // 使用 MAP 的長度判斷
            const maxIndex = Math.max(...Object.values(SHEET_COLUMN_MAP));

            if (finalCols && finalCols.length > maxIndex) {
                const isHeader = isNaN(new Date(finalCols[SHEET_COLUMN_MAP.date]).getTime()) && index === 0;
                
                if (!isHeader) {
                    newData.push({
                        id: Date.now() + index + Math.random(),
                        date: normalizeDate(finalCols[SHEET_COLUMN_MAP.date].trim()),
                        name: finalCols[SHEET_COLUMN_MAP.name].trim(),
                        etiquette: Number(finalCols[SHEET_COLUMN_MAP.etiquette]),
                        voice: Number(finalCols[SHEET_COLUMN_MAP.voice]),
                        knowledge: Number(finalCols[SHEET_COLUMN_MAP.knowledge]),
                        solution: Number(finalCols[SHEET_COLUMN_MAP.solution]),
                        handling: Number(finalCols[SHEET_COLUMN_MAP.handling]),
                    });
                }
            }
        });
        
        processImportData(newData);
        setPasteContent('');
    } catch (e) {
        console.error(e);
        showToast('解析失敗，請確認複製格式', 'error');
    }
  };

  const handleManualSubmit = (e) => {
    e.preventDefault();
    if (!newEntry.name) return showToast('請輸入姓名', 'error');
    
    const entry = {
      ...newEntry,
      id: Date.now(),
      etiquette: Number(newEntry.etiquette),
      voice: Number(newEntry.voice),
      knowledge: Number(newEntry.knowledge),
      solution: Number(newEntry.solution),
      handling: Number(newEntry.handling),
    };
    
    setData([...data, entry]);
    showToast('資料已成功新增', 'success');
    setNewEntry({ ...newEntry, name: '' });
  };

  const handleDelete = (id) => {
    if(window.confirm('確定要刪除這筆資料嗎？')) {
      setData(data.filter(item => item.id !== id));
      showToast('資料已刪除', 'success');
    }
  };

  const handleClearAll = () => {
    if(window.confirm('警告：確定要清空「所有」資料嗎？建議先執行「備份資料庫」。')) {
      setData([]);
      localStorage.removeItem('qa_dashboard_data');
      showToast('所有資料已清空，系統重置完成', 'success');
    }
  };

  const handleExportJSON = () => {
    if (data.length === 0) return showToast('目前無資料可備份', 'error');
    const jsonString = `data:text/json;chatset=utf-8,${encodeURIComponent(
      JSON.stringify(data)
    )}`;
    const link = document.createElement("a");
    link.href = jsonString;
    link.download = `qa_dashboard_backup_${new Date().toISOString().slice(0,10)}.json`;
    link.click();
    showToast(`成功匯出 ${data.length} 筆資料備份`, 'success');
  };

  const handleImportJSON = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const importedData = JSON.parse(e.target.result);
        if (Array.isArray(importedData)) {
          if (window.confirm(`確定要還原 ${importedData.length} 筆資料嗎？這將會覆蓋目前的設定 (如果有相同ID)。\n建議：如果想保留現有資料，請選擇「取消」並改用 CSV 匯入。`)) {
             setData(importedData);
             if (importedData.length > 0) {
               const dates = importedData.map(d => d.date).sort();
               const minMonth = dates[0].slice(0, 7);
               const maxMonth = dates[dates.length - 1].slice(0, 7);
               setTimeout(() => {
                   setDateRange({ start: minMonth, end: maxMonth });
                }, 100);
             }
             showToast('資料庫還原成功！', 'success');
          }
        } else {
          showToast('備份檔案格式錯誤', 'error');
        }
      } catch (err) {
        showToast('檔案讀取失敗，請確認是否為 JSON 備份檔', 'error');
      }
    };
    reader.readAsText(file);
    event.target.value = '';
  };

  const downloadTemplate = () => {
    const csvContent = "data:text/csv;charset=utf-8,日期(YYYY-MM-DD),姓名,電話禮儀,聲音表情,專業知識,問題解決,應對技巧\n2025-01-01,鄭宇嫻,80,85,90,75,80";
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "qa_score_template.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="min-h-screen bg-gray-50 text-gray-800 font-sans relative">
      
      {/* Toast */}
      {toast.show && (
        <div className={`fixed top-4 right-4 z-50 flex items-center p-4 rounded-lg shadow-lg text-white transition-all duration-300 transform translate-y-0 ${toast.type === 'success' ? 'bg-green-600' : 'bg-red-600'}`}>
          {toast.type === 'success' ? <CheckCircle className="w-5 h-5 mr-2" /> : <AlertCircle className="w-5 h-5 mr-2" />}
          <span className="font-medium">{toast.message}</span>
          <button onClick={() => setToast({ ...toast, show: false })} className="ml-4 hover:bg-white/20 rounded-full p-1">
            <X className="w-4 h-4" />
          </button>
        </div>
      )}

      {/* Nav */}
      <nav className="bg-indigo-700 text-white p-4 shadow-lg sticky top-0 z-40">
        <div className="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
          <div className="flex items-center space-x-2">
            <Activity className="h-6 w-6" />
            <span className="text-xl font-bold">客服品質監測中心 (QA Dashboard)</span>
          </div>
          <div className="flex space-x-2 overflow-x-auto w-full md:w-auto pb-2 md:pb-0">
            <button 
              onClick={() => setView('dashboard')}
              className={`flex items-center px-3 py-2 rounded transition whitespace-nowrap ${view === 'dashboard' ? 'bg-indigo-900 font-bold' : 'hover:bg-indigo-600'}`}
            >
              <TrendingUp className="w-4 h-4 mr-1" />
              儀表板
            </button>
            <button 
              onClick={() => setView('comparison')}
              className={`flex items-center px-3 py-2 rounded transition whitespace-nowrap ${view === 'comparison' ? 'bg-indigo-900 font-bold' : 'hover:bg-indigo-600'}`}
            >
              <Layout className="w-4 h-4 mr-1" />
              全員分析
            </button>
            <button 
              onClick={() => setView('entry')}
              className={`flex items-center px-3 py-2 rounded transition whitespace-nowrap ${view === 'entry' ? 'bg-indigo-900 font-bold' : 'hover:bg-indigo-600'}`}
            >
              <PlusCircle className="w-4 h-4 mr-1" />
              資料管理
            </button>
            <button 
              onClick={() => setView('data')}
              className={`flex items-center px-3 py-2 rounded transition whitespace-nowrap ${view === 'data' ? 'bg-indigo-900 font-bold' : 'hover:bg-indigo-600'}`}
            >
              <Database className="w-4 h-4 mr-1" />
              數據表
            </button>
          </div>
        </div>
      </nav>

      {/* Main */}
      <main className="container mx-auto p-6">
        
        {/* Filters */}
        <div className="mb-6 bg-white p-4 rounded-lg shadow flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div className="flex flex-col md:flex-row md:items-center gap-4">
            
            <div className="flex items-center space-x-2">
              <Users className="text-indigo-600" />
              <span className="font-semibold text-gray-700">對象：</span>
              <select 
                value={selectedAgent} 
                onChange={(e) => setSelectedAgent(e.target.value)}
                disabled={view === 'comparison'} 
                className="border-gray-300 border p-2 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none bg-white min-w-[120px] disabled:bg-gray-100 disabled:text-gray-400"
              >
                {agents.map(agent => (
                  <option key={agent} value={agent}>{agent === 'All' ? '全體成員' : agent}</option>
                ))}
              </select>
            </div>

            <div className="flex items-center space-x-2">
              <Calendar className="text-indigo-600" />
              <span className="font-semibold text-gray-700">統計區間：</span>
              <input 
                type="month"
                value={dateRange.start}
                onChange={(e) => setDateRange({...dateRange, start: e.target.value})}
                className="border-gray-300 border p-2 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none bg-white w-32 md:w-36"
              />
              <span className="text-gray-400 font-bold">~</span>
              <input 
                type="month"
                value={dateRange.end}
                onChange={(e) => setDateRange({...dateRange, end: e.target.value})}
                className="border-gray-300 border p-2 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none bg-white w-32 md:w-36"
              />
            </div>
          </div>

          <div className="flex items-center gap-4 text-sm text-gray-500 font-medium">
              <div className="flex items-center text-gray-400">
                <Database className="w-4 h-4 mr-1" />
                總筆數: {data.length}
              </div>
          </div>
        </div>

        {/* Dashboard Views (Content Omitted for Brevity - Same as before) */}
        {view === 'dashboard' && selectedAgent !== 'All' && insights && (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-green-500 flex items-center justify-between">
              <div>
                <p className="text-gray-500 text-sm font-bold">最強優勢項目</p>
                <p className="text-xl font-bold text-gray-800 mt-1">{insights.best.label}</p>
              </div>
              <div className="flex flex-col items-center">
                <Trophy className="text-green-500 w-8 h-8" />
                <span className="text-green-600 font-bold text-lg">{insights.best.score}分</span>
              </div>
            </div>

            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-amber-500 flex items-center justify-between">
              <div>
                <p className="text-gray-500 text-sm font-bold">需加強/最弱項目</p>
                <p className="text-xl font-bold text-gray-800 mt-1">{insights.worst.label}</p>
              </div>
              <div className="flex flex-col items-center">
                <AlertTriangle className="text-amber-500 w-8 h-8" />
                <span className="text-amber-600 font-bold text-lg">{insights.worst.score}分</span>
              </div>
            </div>

            <div className="bg-white p-4 rounded-lg shadow border-l-4 border-indigo-500 flex items-center justify-between">
              <div>
                <p className="text-gray-500 text-sm font-bold">區間綜合平均</p>
                <p className="text-xl font-bold text-gray-800 mt-1">{selectedAgent}</p>
              </div>
              <div className="flex flex-col items-center">
                <Target className="text-indigo-500 w-8 h-8" />
                <span className="text-indigo-600 font-bold text-lg">{insights.totalAvg}分</span>
              </div>
            </div>
          </div>
        )}

        {view === 'dashboard' && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            {/* 1. 五向度雷達圖 */}
            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-100">
              <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center">
                <Search className="w-5 h-5 mr-2" />
                五向度能力分析 
                <span className="ml-2 text-sm font-normal text-gray-500">
                  ({selectedAgent === 'All' ? '團隊平均' : `${selectedAgent} vs 團隊`})
                </span>
              </h3>
              <div className="h-80 w-full flex justify-center">
                {displayData.length > 0 || dateFilteredData.length > 0 ? (
                  <ResponsiveContainer width="100%" height="100%">
                    <RadarChart cx="50%" cy="50%" outerRadius="80%" data={radarData}>
                      <PolarGrid />
                      <PolarAngleAxis dataKey="subject" tick={{ fill: '#4B5563', fontSize: 14 }} />
                      <PolarRadiusAxis angle={30} domain={[0, 100]} tick={{ fontSize: 10 }} />
                      
                      {selectedAgent !== 'All' && (
                        <Radar
                          name="團隊平均"
                          dataKey="team"
                          stroke="#9CA3AF"
                          strokeWidth={2}
                          fill="#D1D5DB"
                          fillOpacity={0.2}
                          strokeDasharray="4 4" 
                        />
                      )}

                      <Radar
                        name={selectedAgent === 'All' ? '團隊平均' : selectedAgent}
                        dataKey="current"
                        stroke="#4F46E5"
                        strokeWidth={3}
                        fill="#6366F1"
                        fillOpacity={0.4}
                      />
                      
                      <Legend />
                      <Tooltip />
                    </RadarChart>
                  </ResponsiveContainer>
                ) : (
                  <div className="flex flex-col items-center justify-center h-full text-gray-400">
                    <FileText className="w-12 h-12 mb-2 opacity-50" />
                    <p>該區間無資料</p>
                  </div>
                )}
              </div>
            </div>

            {/* 2. 長期趨勢圖 */}
            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-100">
              <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center">
                <TrendingUp className="w-5 h-5 mr-2" />
                各項指標走勢追蹤
              </h3>
              <div className="mb-2 text-xs text-gray-500 text-right">
                區間：{dateRange.start} ~ {dateRange.end}
              </div>
              <div className="h-80 w-full">
                {displayData.length > 0 ? (
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={trendData}>
                      <CartesianGrid strokeDasharray="3 3" vertical={false} />
                      <XAxis dataKey="date" tick={{fontSize: 12}} />
                      <YAxis domain={[0, 100]} ticks={[0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100]} interval={0} />
                      <Tooltip 
                        contentStyle={{ backgroundColor: '#fff', borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)' }}
                      />
                      <Legend />
                      <Line type="monotone" dataKey="etiquette" name="電話禮儀" stroke={COLORS.etiquette} strokeWidth={2} dot={{ r: 3 }} />
                      <Line type="monotone" dataKey="voice" name="聲音表情" stroke={COLORS.voice} strokeWidth={2} dot={{ r: 3 }} />
                      <Line type="monotone" dataKey="knowledge" name="專業知識" stroke={COLORS.knowledge} strokeWidth={2} dot={{ r: 3 }} />
                      <Line type="monotone" dataKey="solution" name="問題解決" stroke={COLORS.solution} strokeWidth={2} dot={{ r: 3 }} />
                      <Line type="monotone" dataKey="handling" name="應對技巧" stroke={COLORS.handling} strokeWidth={2} dot={{ r: 3 }} />
                    </LineChart>
                  </ResponsiveContainer>
                ) : (
                  <div className="flex flex-col items-center justify-center h-full text-gray-400">
                    <p>無數據可顯示</p>
                  </div>
                )}
              </div>
            </div>

            {/* 3. 各項指標長條圖比較 */}
            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-100">
              <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center">
                 <Info className="w-5 h-5 mr-2 text-indigo-600" />
                 各項指標平均分數
              </h3>
              <div className="h-64 w-full">
                 {displayData.length > 0 ? (
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={radarData} layout="vertical" margin={{ top: 5, right: 30, left: 40, bottom: 5 }}>
                      <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                      <XAxis type="number" domain={[0, 100]} ticks={[0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100]} />
                      <YAxis dataKey="subject" type="category" width={80} />
                      <Tooltip cursor={{fill: 'transparent'}} />
                      <Bar dataKey="current" name={selectedAgent === 'All' ? '團隊平均' : selectedAgent} fill="#4F46E5" radius={[0, 4, 4, 0]} barSize={30} label={{ position: 'right', fill: '#4F46E5', fontWeight: 'bold' }} />
                    </BarChart>
                  </ResponsiveContainer>
                 ) : (
                  <div className="flex items-center justify-center h-full text-gray-400">
                    <p>無數據</p>
                  </div>
                 )}
              </div>
            </div>

            {/* 4. 建議評語總結 */}
            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-100 flex flex-col">
              <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center">
                 <MessageSquare className="w-5 h-5 mr-2 text-indigo-600" />
                 建議評語總結 (AI Summary)
              </h3>
              {summaryText ? (
                <div className="flex-1 flex flex-col justify-center space-y-4">
                  <div className="bg-gray-50 p-4 rounded-lg">
                    <p className="text-sm text-gray-700 leading-relaxed font-medium">
                      {summaryText.comment}
                    </p>
                  </div>

                  <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                    <p className="text-xs text-indigo-500 font-bold mb-1 uppercase">Action Item / 行動建議</p>
                    <p className="text-sm text-indigo-800 leading-relaxed">
                      {summaryText.advice}
                    </p>
                  </div>
                </div>
              ) : (
                <div className="flex-1 flex items-center justify-center text-gray-400">
                   <p>無足夠數據生成評語</p>
                </div>
              )}
            </div>
          </div>
        )}

        {view === 'comparison' && (
           <div className="space-y-6">
            <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100 flex items-center">
              <Info className="w-5 h-5 text-indigo-600 mr-2" />
              <p className="text-sm text-indigo-800">
                此頁面顯示 <strong>{dateRange.start} ~ {dateRange.end}</strong> 區間內所有人員的綜合能力雷達圖。灰色區域為團隊平均值，可作為對照參考。
              </p>
            </div>

            {dateFilteredData.length === 0 ? (
               <div className="flex flex-col items-center justify-center h-64 bg-white rounded-xl shadow text-gray-400">
                  <FileText className="w-16 h-16 mb-4 opacity-30" />
                  <p className="text-lg font-medium">此區間無數據</p>
                  <p className="text-sm">請調整日期或匯入資料</p>
               </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {(() => {
                  const teamRadarStats = CATEGORIES.map(cat => {
                    const total = dateFilteredData.reduce((sum, item) => sum + Number(item[cat.key]), 0);
                    return dateFilteredData.length ? Math.round(total / dateFilteredData.length) : 0;
                  });

                  const uniqueAgents = Array.from(new Set(dateFilteredData.map(d => d.name)));
                  
                  const agentCards = uniqueAgents.map(agentName => {
                      const agentData = dateFilteredData.filter(d => d.name === agentName);
                      const agentRadar = CATEGORIES.map((cat, index) => {
                        const total = agentData.reduce((sum, item) => sum + Number(item[cat.key]), 0);
                        const avg = agentData.length ? Math.round(total / agentData.length) : 0;
                        return {
                          subject: cat.label,
                          A: avg, // Agent
                          B: teamRadarStats[index], // Team
                          fullMark: 100
                        };
                      });
                      const totalScore = Math.round(agentRadar.reduce((acc, curr) => acc + curr.A, 0) / 5);
                      return { name: agentName, data: agentRadar, score: totalScore, count: agentData.length };
                  }).sort((a, b) => b.score - a.score);

                  return agentCards.map((agent) => (
                    <div key={agent.name} className="bg-white p-5 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition-shadow">
                        <div className="flex justify-between items-start mb-4 border-b pb-2">
                           <div>
                              <h3 className="font-bold text-lg text-gray-800 flex items-center">
                                {agent.name}
                                {agent.score >= 90 && <Star className="w-4 h-4 text-yellow-500 fill-current ml-1" />}
                              </h3>
                              <p className="text-xs text-gray-500">樣本數: {agent.count} 筆</p>
                           </div>
                           <div className={`px-3 py-1 rounded-lg text-sm font-bold flex flex-col items-center ${agent.score >= 90 ? 'bg-green-100 text-green-700' : agent.score < 70 ? 'bg-red-100 text-red-700' : 'bg-indigo-50 text-indigo-700'}`}>
                             <span>{agent.score}</span>
                             <span className="text-[10px] opacity-70">平均分</span>
                           </div>
                        </div>
                        <div className="h-64 w-full">
                          <ResponsiveContainer width="100%" height="100%">
                              <RadarChart cx="50%" cy="50%" outerRadius="70%" data={agent.data}>
                                <PolarGrid />
                                <PolarAngleAxis dataKey="subject" tick={{ fontSize: 11, fill: '#6B7280' }} />
                                <PolarRadiusAxis angle={30} domain={[0, 100]} tick={false} axisLine={false} />
                                <Radar name="團隊平均" dataKey="B" stroke="#9CA3AF" fill="#D1D5DB" fillOpacity={0.15} />
                                <Radar name={agent.name} dataKey="A" stroke="#4F46E5" strokeWidth={2} fill="#6366F1" fillOpacity={0.4} />
                                <Tooltip wrapperStyle={{ zIndex: 100 }} contentStyle={{ fontSize: '12px' }} />
                                <Legend wrapperStyle={{ fontSize: '11px', marginTop: '5px' }} />
                              </RadarChart>
                          </ResponsiveContainer>
                        </div>
                    </div>
                  ));
                })()}
              </div>
            )}
          </div>
        )}

        {view === 'entry' && (
          <div className="grid grid-cols-1 gap-8">
            {/* 1. 資料庫管理區 */}
            <div className="bg-indigo-50 p-6 rounded-xl shadow-md border border-indigo-100">
              <h3 className="text-lg font-bold text-indigo-800 mb-4 flex items-center">
                <Database className="w-5 h-5 mr-2" />
                資料庫管理 (備份/還原)
              </h3>
              <p className="text-sm text-gray-600 mb-4">
                由於瀏覽器限制，建議您定期備份資料庫。目前的 <strong>{data.length}</strong> 筆資料可以匯出為一個備份檔，作為您的「基礎版」存檔。
              </p>
              <div className="flex flex-col md:flex-row gap-4">
                <button 
                  onClick={handleExportJSON}
                  className="flex-1 flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-sm"
                >
                  <Save className="w-5 h-5 mr-2" />
                  備份目前資料庫 (下載 JSON)
                </button>
                
                <div className="flex-1 relative">
                   <input 
                    type="file" 
                    accept=".json"
                    onChange={handleImportJSON}
                    className="hidden" 
                    id="json-restore"
                  />
                  <label 
                    htmlFor="json-restore" 
                    className="flex items-center justify-center bg-white border-2 border-indigo-600 text-indigo-600 hover:bg-indigo-50 font-bold py-3 px-4 rounded-lg transition shadow-sm cursor-pointer"
                  >
                    <RefreshCw className="w-5 h-5 mr-2" />
                    還原備份資料 (匯入 JSON)
                  </label>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              {/* 2. 手動輸入區 */}
              <div className="bg-white p-6 rounded-xl shadow-md">
                <h3 className="text-lg font-bold text-gray-700 mb-6 flex items-center">
                  <PlusCircle className="w-5 h-5 mr-2" />
                  新增單筆評核紀錄
                </h3>
                <form onSubmit={handleManualSubmit} className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">日期</label>
                      <input 
                        type="date" 
                        required
                        className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                        value={newEntry.date}
                        onChange={e => setNewEntry({...newEntry, date: e.target.value})}
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">客服人員姓名</label>
                      <input 
                        type="text" 
                        required
                        placeholder="例如: 王小美"
                        className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                        value={newEntry.name}
                        onChange={e => setNewEntry({...newEntry, name: e.target.value})}
                      />
                    </div>
                  </div>

                  <div className="space-y-4 border-t pt-4 mt-2">
                    <p className="text-sm text-gray-500 font-bold">五向度評分 (0-100)</p>
                    {CATEGORIES.map(cat => (
                      <div key={cat.key} className="flex items-center justify-between">
                        <label className="text-sm text-gray-700 w-24">{cat.label}</label>
                        <input 
                          type="range" 
                          min="0" 
                          max="100" 
                          className="flex-1 mx-4 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                          value={newEntry[cat.key]}
                          onChange={e => setNewEntry({...newEntry, [cat.key]: Number(e.target.value)})}
                        />
                        <input 
                          type="number" 
                          min="0" 
                          max="100"
                          className="w-16 p-1 border rounded text-center"
                          value={newEntry[cat.key]}
                          onChange={e => setNewEntry({...newEntry, [cat.key]: Number(e.target.value)})}
                        />
                      </div>
                    ))}
                  </div>

                  <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition mt-4">
                    儲存評分
                  </button>
                </form>
              </div>

              {/* 3. 資料匯入區 (CSV / 貼上 / Google Sheet) */}
              <div className="space-y-6">
                
                {/* 貼上區塊 */}
                <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                   <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center">
                    <Clipboard className="w-5 h-5 mr-2 text-green-600" />
                    從 Excel / Google Sheets 快速貼上
                  </h3>
                  <div className="space-y-2">
                    <p className="text-sm text-gray-600">
                      直接在試算表選取範圍 (不含標題)，按下 <kbd className="px-1 py-0.5 rounded bg-gray-100 border font-mono">Ctrl+C</kbd>，然後在下方 <kbd className="px-1 py-0.5 rounded bg-gray-100 border font-mono">Ctrl+V</kbd>。
                    </p>
                    <p className="text-xs text-gray-500 mb-2">
                      順序：日期 | 姓名 | 電話禮儀 | 聲音表情 | 專業知識 | 問題解決 | 應對技巧
                    </p>
                    <textarea 
                      className="w-full h-24 p-2 border rounded bg-gray-50 focus:bg-white focus:ring-2 focus:ring-green-500 text-sm font-mono"
                      placeholder={`2025-01-01\t王小美\t80\t85\t90\t75\t80\n2025-01-02\t李大明\t70\t80\t85\t90\t75`}
                      value={pasteContent}
                      onChange={(e) => setPasteContent(e.target.value)}
                    ></textarea>
                    <button 
                      onClick={handleSmartPaste}
                      className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition"
                    >
                      解析並匯入貼上內容
                    </button>
                  </div>
                </div>

                {/* Google Sheet URL 匯入 */}
                <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                   <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center">
                    <Globe className="w-5 h-5 mr-2 text-blue-600" />
                    從 Google Sheet 公開連結同步
                  </h3>
                  <div className="space-y-3">
                    <div className="text-sm text-gray-600">
                      <p className="mb-1">1. 確保 Google Sheet 權限設定為 <strong>知道連結者皆可檢視</strong>。</p>
                      <p className="mb-1">2. 系統會自動抓取第 1 個分頁 (GID)。</p>
                      <p>3. 貼上瀏覽器網址列的連結並點擊同步：</p>
                    </div>
                    <div className="flex gap-2">
                        <input 
                            type="text"
                            className="flex-1 p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500"
                            placeholder="https://docs.google.com/spreadsheets/d/..."
                            value={googleSheetUrl}
                            onChange={(e) => setGoogleSheetUrl(e.target.value)}
                        />
                        <button 
                          onClick={handleGoogleSheetImport}
                          className="bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-lg transition flex items-center whitespace-nowrap"
                        >
                          <RefreshCw className="w-4 h-4 mr-2" />
                          立即同步 (Sync)
                        </button>
                    </div>
                  </div>
                </div>

                {/* CSV 上傳區塊 */}
                <div className="bg-white p-6 rounded-xl shadow-md">
                  <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center">
                    <Upload className="w-5 h-5 mr-2" />
                    批次匯入 CSV 檔案
                  </h3>
                  <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition">
                    <input 
                      type="file" 
                      accept=".csv"
                      onChange={handleFileUpload}
                      className="hidden" 
                      id="csv-upload"
                    />
                    <label htmlFor="csv-upload" className="cursor-pointer flex flex-col items-center">
                      <FileSpreadsheet className="w-10 h-10 text-gray-400 mb-2" />
                      <span className="text-indigo-600 font-semibold">點擊上傳 CSV</span>
                    </label>
                  </div>
                  
                  <div className="mt-4 text-center">
                    <button 
                      onClick={downloadTemplate}
                      className="text-sm text-indigo-600 hover:text-indigo-800 font-semibold flex items-center justify-center w-full"
                    >
                      <Download className="w-4 h-4 mr-1" />
                      下載 CSV 範本
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {view === 'data' && (
          <div className="bg-white rounded-xl shadow-md overflow-hidden">
              <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                <h3 className="font-bold text-gray-700">
                  原始資料列表 ({displayData.length} 筆)
                  <span className="ml-2 text-sm font-normal text-gray-500">
                      - 顯示 {dateRange.start} ~ {dateRange.end} 資料
                  </span>
                </h3>
                <button 
                  onClick={handleClearAll}
                  className="flex items-center px-3 py-2 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition"
                >
                  <RotateCcw className="w-4 h-4 mr-1" />
                  重置/清空所有資料
                </button>
              </div>
              <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                      {CATEGORIES.map(cat => (
                        <th key={cat.key} className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{cat.label}</th>
                      ))}
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {displayData.map((row) => (
                      <tr key={row.id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{row.date}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600">{row.name}</td>
                        {CATEGORIES.map(cat => (
                          <td key={cat.key} className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span className={`px-2 py-1 rounded-full text-xs font-semibold ${row[cat.key] >= 90 ? 'bg-green-100 text-green-800' : row[cat.key] < 70 ? 'bg-red-100 text-red-800' : 'bg-gray-100'}`}>
                              {row[cat.key]}
                            </span>
                          </td>
                        ))}
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          <button 
                            onClick={() => handleDelete(row.id)}
                            className="text-red-500 hover:text-red-700"
                          >
                            <Trash2 className="w-5 h-5" />
                          </button>
                        </td>
                      </tr>
                    ))}
                    {displayData.length === 0 && (
                      <tr>
                        <td colSpan="8" className="px-6 py-8 text-center text-gray-400">
                          此區間無評分資料
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
          </div>
        )}

      </main>
    </div>
  );
};

export default App;
